from google import genai
#from PIL import Image
import requests
client = genai.Client(api_key="AIzaSyBYITyYSdlX1HFNpx21y0_ohI4fRtbxWQ4")
chat = client.chats.create(model='gemini-2.0-flash')
prompt = """
你是一個專門幫助兒童學習書寫的 AI，擁有高度的手寫辨識能力。你的目標是：
1. **辨識這張圖片中的手寫文字(可能是中文可能是英文)**，將其轉換為標準的電腦文字（OCR）。
2. **判斷這些字是否正確**，並標記錯誤字（如果有）。
3. **分析錯誤的原因**，並根據錯誤類型提供有針對性的回饋。可能的錯誤類型包括：
   - **形近字錯誤**（如「在」寫成「再」）
   - **筆畫錯誤**（如少一筆或多一筆）
   - **部件分離或結構錯誤**（如「是」寫成「日」+「目」）
   - **比例與間距錯誤**（如筆畫太靠近或太分散）
4. **提供具體的建議與正確範例**，幫助小朋友理解怎麼寫得更好。
5. **請使用親切、鼓勵的語氣**，讓小朋友願意改進，而不是感到挫折。

而正確答案與圖片中的文字會一起傳給你，請你根據這些資訊來給予小朋友回饋，
正確答案：
"""

output_prompt = """
### **範例輸出**
如果小朋友把正確答案「鬧」寫成傳給你的圖片中辨識到的「開」：
請回傳
❌ **你的「鬧」字寫錯了哦！右邊應該是「市」，但你寫成了「開」的部件「廾」！**
✅ **正確的「鬧」應該是「鬥」+「市」，你可以試試看這樣寫！**

如果字寫歪了：
🔹 **「開」字很棒！但左邊的「門」要再直一點，這樣看起來會更整齊哦！**

請按照這種方式給出詳細的回饋，並確保讓小朋友容易理解，再給予100分中小朋友獲得幾分的評分。讓我們開始吧！
回饋部分請用中文回復，回復格式如下(json)：
{
    "letter": "鬧",
    "feedback": "你的「鬧」字寫錯了哦！右邊應該是「市」，但你寫成了「開」的部件「廾」！\n正確的「鬧」應該是「鬥」+「市」，你可以試試看這樣寫！",
    "score": 80
}
或者
{
    "letter": "b",
    "feedback": "b字很棒！但左邊的直線要再直一點，中間的圓形要放在方格下方「正中間」，這樣看起來會更整齊哦！",
    "score": 93
}
letter是圖片中辨識到的文字，feedback是對小朋友的回饋，score是小朋友獲得的分數。請注意，這些字可能是中文也可能是英文，請根據圖片中的文字來給予回饋。
注意letter 不要回傳正確答案喔，要回傳「圖片」中辨識到的文字
請只回 JSON，不要加任何說明文字、也不要任何```和```json 謝謝你。
"""


def get_gemini_response_from_image(ans, image):
  response = chat.send_message(
    message=[
      prompt,
      ans,
      image, 
      output_prompt
    ]
  )
  return response.text
#chat.send_message 會有記憶嗎